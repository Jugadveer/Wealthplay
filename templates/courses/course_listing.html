{% extends 'base.html' %}
{% load static %}

{% block title %}Learn to Invest - WealthPlay{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary: #14B8A6;
        --primary-dark: #0D9488;
        --secondary: #EA580C;
        --bg-light: #F9FAFB;
        --text-main: #1F2937;
        --text-light: #6B7280;
        --border: #E5E7EB;
        --success: #10B981;
        --warning: #F59E0B;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    body {
        background-color: var(--bg-light);
        color: var(--text-main);
    }

    .course-page-container {
        min-height: calc(100vh - 70px);
        padding: 40px 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .page-header {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 30px;
    }

    .back-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        border: 2px solid var(--border);
        background: white;
        color: var(--text-main);
        cursor: pointer;
        transition: all 0.3s;
        text-decoration: none;
    }

    .back-btn:hover {
        border-color: var(--primary);
        color: var(--primary);
        transform: translateX(-3px);
    }

    .header-content {
        display: flex;
        align-items: center;
        gap: 12px;
        flex: 1;
    }

    .header-icon {
        font-size: 28px;
        color: var(--primary);
    }

    .header-title h1 {
        font-size: 32px;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
        line-height: 1.2;
    }

    .header-title p {
        font-size: 16px;
        color: var(--text-light);
        margin: 4px 0 0 0;
    }

    .progress-card {
        background: white;
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 30px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .progress-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .progress-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-main);
    }

    .progress-stats {
        font-size: 14px;
        color: var(--text-light);
        font-weight: 500;
    }

    .progress-bar-wrapper {
        width: 100%;
        height: 12px;
        background: var(--border);
        border-radius: 6px;
        overflow: hidden;
        display: flex;
    }

    .progress-bar-filled {
        height: 100%;
        background: linear-gradient(90deg, var(--primary) 0%, var(--secondary) 100%);
        transition: width 0.5s ease;
        border-radius: 6px;
    }

    .courses-container {
        display: flex;
        flex-direction: column;
        gap: 24px;
    }

    .course-section {
        background: white;
        border-radius: 16px;
        padding: 24px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 20px;
    }

    .section-icon {
        font-size: 24px;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
        background: var(--bg-light);
    }

    .section-title {
        font-size: 22px;
        font-weight: 700;
        color: var(--text-main);
    }

    .lessons-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .lesson-card {
        display: flex;
        align-items: center;
        gap: 16px;
        padding: 16px;
        border: 2px solid var(--border);
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s;
        background: white;
    }

    .lesson-card:hover {
        border-color: var(--primary);
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(20,184,166,0.15);
    }

    .lesson-card.locked {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .lesson-card.locked:hover {
        transform: none;
        border-color: var(--border);
        box-shadow: none;
    }

    .lesson-status {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        flex-shrink: 0;
        font-weight: 600;
    }

    .lesson-status.completed {
        background: var(--success);
        color: white;
    }

    .lesson-status.current {
        background: var(--primary);
        color: white;
        border: 3px solid var(--primary-dark);
    }

    .lesson-status.locked {
        background: var(--bg-light);
        color: var(--text-light);
    }

    .lesson-content {
        flex: 1;
    }

    .lesson-title {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-main);
        margin-bottom: 4px;
    }

    .lesson-description {
        font-size: 14px;
        color: var(--text-light);
        margin-bottom: 8px;
    }

    .lesson-meta {
        display: flex;
        gap: 16px;
        align-items: center;
        font-size: 13px;
        color: var(--text-light);
    }

    .lesson-duration {
        display: flex;
        align-items: center;
        gap: 4px;
    }

    .xp-badge {
        background: linear-gradient(135deg, #FCD34D 0%, #F59E0B 100%);
        color: white;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
    }

    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: var(--text-light);
    }

    .empty-state-icon {
        font-size: 64px;
        margin-bottom: 16px;
        opacity: 0.5;
    }

    .loading-spinner {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 400px;
    }

    .spinner {
        width: 48px;
        height: 48px;
        border: 4px solid var(--border);
        border-top-color: var(--primary);
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .user-level-badge {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        background: var(--bg-light);
        color: var(--text-main);
        margin-left: 12px;
    }

    .header-actions {
        display: flex;
        align-items: center;
        gap: 12px;
    }

    .level-filter-wrapper {
        position: relative;
    }

    .level-filter {
        padding: 10px 16px;
        padding-right: 40px;
        border: 2px solid var(--border);
        border-radius: 10px;
        background: white;
        color: var(--text-main);
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%231F2937' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 12px;
        transition: all 0.3s;
        min-width: 140px;
    }

    .level-filter:hover {
        border-color: var(--primary);
    }

    .level-filter:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(20, 184, 166, 0.1);
    }

    .user-xp {
        display: inline-block;
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 12px;
        font-weight: 600;
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
    }

    .level-section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin: 40px 0 20px 0;
        padding-bottom: 16px;
        border-bottom: 2px solid var(--border);
    }

    .level-section-header:first-of-type {
        margin-top: 0;
    }

    .level-header-title {
        font-size: 24px;
        font-weight: 700;
        color: var(--text-main);
        margin: 0;
    }

    .level-header-icon {
        font-size: 28px;
    }
</style>
{% endblock %}

{% block content %}
<div class="course-page-container">
    <div class="page-header">
        <a href="/" class="back-btn">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div class="header-content">
            <div class="header-icon">
                <i class="fas fa-book"></i>
            </div>
            <div class="header-title">
                <h1>Learn to Invest</h1>
                <p>Master investing one lesson at a time</p>
            </div>
        </div>
        <div class="header-actions">
            <div class="level-filter-wrapper">
                <select id="level-filter" class="level-filter">
                    <option value="beginner">Beginner</option>
                    <option value="intermediate">Intermediate</option>
                    <option value="advanced">Advanced</option>
                    <option value="all">All</option>
                </select>
            </div>
            <div id="user-stats" style="display: none;">
                <span class="user-xp" id="user-xp">0 XP</span>
            </div>
        </div>
    </div>

    <div class="progress-card">
        <div class="progress-header">
            <div class="progress-title">Your Progress</div>
            <div class="progress-stats" id="progress-stats">0/0 lessons completed</div>
        </div>
        <div class="progress-bar-wrapper">
            <div class="progress-bar-filled" id="progress-bar" style="width: 0%;"></div>
        </div>
    </div>

    <div id="courses-container" class="courses-container">
        <div class="loading-spinner">
            <div class="spinner"></div>
        </div>
    </div>
</div>

<script>
let allCourses = [];
let userProgress = {};
let userProfile = { level: 'beginner', xp: 0 };
let currentFilter = 'beginner'; // Default filter

// Load user profile
async function loadUserProfile() {
    try {
        const response = await fetch('/api/users/profile/');
        if (response.ok) {
            userProfile = await response.json();
            // Set default filter to user's level
            currentFilter = userProfile.level || 'beginner';
            
            // Update filter dropdown
            const filterSelect = document.getElementById('level-filter');
            if (filterSelect) {
                filterSelect.value = currentFilter;
            }
            
            document.getElementById('user-xp').textContent = `${userProfile.xp} XP`;
            document.getElementById('user-stats').style.display = 'block';
        }
    } catch (error) {
        console.error('Error loading profile:', error);
    }
}

// Load all courses
async function loadCourses() {
    try {
        const response = await fetch('/api/courses/json/');
        if (response.ok) {
            allCourses = await response.json();
            await loadUserProgress();
            renderCourses();
            updateProgress();
        } else {
            showError('Failed to load courses');
        }
    } catch (error) {
        console.error('Error loading courses:', error);
        showError('Error loading courses. Please refresh the page.');
    }
}

// Load user progress for all courses
async function loadUserProgress() {
    try {
        const response = await fetch('/api/users/progress/');
        if (response.ok) {
            const progress = await response.json();
            // Index progress by course_id and module_id
            progress.forEach(p => {
                if (p.course_id && p.module_id) {
                    const key = `${p.course_id}_${p.module_id}`;
                    userProgress[key] = p;
                }
            });
        }
    } catch (error) {
        console.error('Error loading progress:', error);
    }
}

// Check if module is unlocked
function isModuleUnlocked(course, module) {
    const key = `${course.id}_${module.id}`;
    const progress = userProgress[key];
    
    // If completed or in progress, it's unlocked
    if (progress && (progress.status === 'completed' || progress.status === 'in_progress')) {
        return true;
    }
    
    // Check course unlock requirement
    if (course.xp_to_unlock && course.xp_to_unlock > userProfile.xp) {
        return false;
    }
    
    // Check level requirement
    if (course.level && course.level === 'advanced' && userProfile.level === 'beginner') {
        return false;
    }
    
    // Check sequential unlock rule
    if (module.lock_rule === 'sequential' && module.order > 1) {
        // Check if previous module is completed
        const prevModule = course.modules.find(m => m.order === module.order - 1);
        if (prevModule) {
            const prevKey = `${course.id}_${prevModule.id}`;
            const prevProgress = userProgress[prevKey];
            if (!prevProgress || prevProgress.status !== 'completed') {
                return false;
            }
        }
    }
    
    // For intermediate users, unlock beginner courses
    if (userProfile.level === 'intermediate' && course.level === 'beginner') {
        return true;
    }
    
    // First module is always unlocked if course is unlocked
    if (module.order === 1) {
        return course.xp_to_unlock <= userProfile.xp;
    }
    
    return false;
}

// Get module status
function getModuleStatus(course, module) {
    const key = `${course.id}_${module.id}`;
    const progress = userProgress[key];
    
    if (progress) {
        if (progress.status === 'completed') {
            return 'completed';
        }
        if (progress.status === 'in_progress' || progress.status === 'unlocked') {
            return 'current';
        }
    }
    
    if (isModuleUnlocked(course, module)) {
        return 'unlocked';
    }
    
    return 'locked';
}

// Render all courses based on current filter
function renderCourses() {
    const container = document.getElementById('courses-container');
    
    if (!allCourses || allCourses.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“š</div>
                <h3>No courses available</h3>
                <p>Check back later for new content.</p>
            </div>
        `;
        return;
    }
    
    // Filter courses based on current filter
    let coursesToShow = [];
    if (currentFilter === 'all') {
        // Show all courses
        coursesToShow = allCourses;
    } else {
        // Filter by selected level
        coursesToShow = allCourses.filter(course => {
            const courseLevel = course.level || 'beginner';
            return courseLevel === currentFilter;
        });
    }
    
    // Group courses by level for rendering
    const coursesByLevel = {
        beginner: [],
        intermediate: [],
        advanced: []
    };
    
    coursesToShow.forEach(course => {
        const level = course.level || 'beginner';
        coursesByLevel[level].push(course);
    });
    
    let html = '';
    const icons = {
        beginner: 'ðŸŒ±',
        intermediate: 'ðŸ“ˆ',
        advanced: 'ðŸš€'
    };
    
    // If showing all, render in order: beginner â†’ intermediate â†’ advanced
    // If filtering by level, render only that level
    const levelsToRender = currentFilter === 'all' 
        ? ['beginner', 'intermediate', 'advanced'] 
        : [currentFilter];
    
    levelsToRender.forEach(level => {
        const courses = coursesByLevel[level];
        if (courses.length === 0) return;
        
        // Add level header if showing all
        if (currentFilter === 'all') {
            html += `
                <div class="level-section-header">
                    <h2 class="level-header-title">${level.charAt(0).toUpperCase() + level.slice(1)} Level</h2>
                    <div class="level-header-icon">${icons[level] || 'ðŸ“š'}</div>
                </div>
            `;
        }
        
        courses.forEach(course => {
            const modules = course.modules || [];
            let moduleCards = '';
            
            modules.forEach(module => {
                const status = getModuleStatus(course, module);
                const statusClass = status === 'locked' ? 'locked' : '';
                const statusIcon = status === 'completed' ? 'âœ“' : 
                                  status === 'current' ? 'â—‹' : 
                                  status === 'locked' ? 'ðŸ”’' : 'â—‹';
                
                moduleCards += `
                    <div class="lesson-card ${statusClass}" data-course-id="${course.id}" data-module-id="${module.id}" onclick="openLesson('${course.id}', '${module.id}')">
                        <div class="lesson-status ${status}">${statusIcon}</div>
                        <div class="lesson-content">
                            <div class="lesson-title">${module.title || 'Untitled'}</div>
                            <div class="lesson-description">${module.summary || ''}</div>
                            <div class="lesson-meta">
                                <div class="lesson-duration">
                                    <i class="far fa-clock"></i>
                                    <span>${module.duration_min || 0} min</span>
                                </div>
                                <div class="xp-badge">+${module.xp_reward || 0} XP</div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (moduleCards) {
                html += `
                    <div class="course-section">
                        <div class="section-header">
                            <div class="section-icon">${icons[level] || 'ðŸ“š'}</div>
                            <div class="section-title">${course.title || 'Untitled Course'}</div>
                        </div>
                        <div class="lessons-list">
                            ${moduleCards}
                        </div>
                    </div>
                `;
            }
        });
    });
    
    container.innerHTML = html || `
        <div class="empty-state">
            <div class="empty-state-icon">ðŸ“š</div>
            <h3>No lessons available</h3>
            <p>Start learning to unlock more content!</p>
        </div>
    `;
}

// Update progress bar
function updateProgress() {
    let totalLessons = 0;
    let completedLessons = 0;
    
    allCourses.forEach(course => {
        (course.modules || []).forEach(module => {
            totalLessons++;
            const key = `${course.id}_${module.id}`;
            const progress = userProgress[key];
            if (progress && progress.status === 'completed') {
                completedLessons++;
            }
        });
    });
    
    const percent = totalLessons > 0 ? (completedLessons / totalLessons) * 100 : 0;
    document.getElementById('progress-bar').style.width = percent + '%';
    document.getElementById('progress-stats').textContent = `${completedLessons}/${totalLessons} lessons completed`;
}

// Open lesson
function openLesson(courseId, moduleId) {
    // Check if unlocked
    const course = allCourses.find(c => c.id === courseId);
    if (!course) return;
    
    const module = (course.modules || []).find(m => m.id === moduleId);
    if (!module) return;
    
    if (!isModuleUnlocked(course, module)) {
        alert('Complete the previous lesson to unlock this one!');
        return;
    }
    
    // Navigate to lesson page
    window.location.href = `/course/${courseId}/${moduleId}/`;
}

// Handle filter change
function handleFilterChange() {
    const filterSelect = document.getElementById('level-filter');
    if (filterSelect) {
        filterSelect.addEventListener('change', function(e) {
            currentFilter = e.target.value;
            renderCourses();
        });
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    loadUserProfile();
    loadCourses();
    handleFilterChange();
});
</script>
{% endblock %}

